<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<meta name="color-scheme" content="light only">
<meta name="supported-color-schemes" content="light">

    <title>ìºë¦­í„° ëŒ€í™”ì°½</title>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <div class="character-image"></div>
    <div class="blurry-background"></div>
    <div class="container">
        <div class="top-container">
            <a href="/" style="color: inherit; text-decoration: none;"><div class="navi">Home</div></a>
           <div class="navi" onclick="printHistory()">History</div>
        </div>
        <button class="HistoryCloseButton" onclick="closeHistory()">X</button>
        <div class="history-container"></div>
        
        <div class="bottom-container">
            <div class="name">ë‚˜ì˜ ì™•êµ­ ë¶€í™œê¸°</div>
            <div class="name-dialogue">
                <div class="dialogue">
                    <p>ì—ìŠ¤í…Œë¦¬ì•„ì˜ ì„¸ê³„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.</p>
                    <p>ë‹¹ì‹ ì€ ë©¸ë§í•œ ì—í…Œë£¨ë©˜ ì™•êµ­ì˜ ë§ˆì§€ë§‰ ì™•ì¡±ì…ë‹ˆë‹¤.</p>
                    <p>í˜„ì¬ëŠ” ì‹œì¢… í•œë‹ˆë°œê³¼ í•¨ê»˜ ìˆ²ì† ì˜¤ë‘ë§‰ì—ì„œ ì€ë‘”ìƒí™œì„ í•˜ê³ ìˆìŠµë‹ˆë‹¤</p>
                    <p>ì™•êµ­ì„ ì¬ê±´í•˜ê¸° ìœ„í•œ ì—¬ì •ì„ ì‹œì‘í•˜ì‹­ì‹œìš”.</p>
                </div>
            </div>
            <div class="status">
                <div class="status-content">
                    <div class="status-text">ğŸ’–HP: 100/100 ğŸ’MP: 50/50</div>
                    
                    <div class="buttons">
                        <button class="close">â€º</button>
                    </div>
                </div>
            </div>
            <div class="input-box">
                <div class="input-container">
                    <input id="input_prompt" type="text" placeholder="ëŒ€í™”ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” ì˜ˆ) ì•ˆë…•, ë°˜ê°€ì›Œ">
                    <img src="static/spinner.gif" alt="ë¡œë”© ì¤‘" class="loading-gif" id="loadingGif" style="display: none;">
                </div>
                <div class="buttons">
                    <button class="rocket">âœ¨</button>
                    <!-- <button class="menu">â˜°</button> -->
                    <button class="next" onclick="onClickSend()">â€º</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        var chatRoomId = "{{ chat_room_id }}";
        const bottomContent = document.querySelector(".bottom-container");
        const viewportHeight = window.innerHeight;
        const contentRect = bottomContent.getBoundingClientRect();
        const bottomOffset = viewportHeight - contentRect.bottom;
        const loadingGif = document.getElementById('loadingGif');
        if (bottomOffset < 20) {
            bottomContent.style.bottom = `${20 - bottomOffset}px`;
        }
       // chatRoomId = '20250101_164235';
        if (typeof chatRoomId !== 'undefined' && chatRoomId !== null && chatRoomId !== '') {
            console.log("chatRoomId",chatRoomId)
            fetch('/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ chatRoomId: chatRoomId  })
            })
            .then(response => {
            if (!response.ok) {
                throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
            }
            return response.json();
            })
            .then(data => {
                //TODO:ëŒ€í™”ë‚´ìš© ë³µì›í•˜ê¸°. íˆìŠ¤í† ë¦¬ ë° ë°°ê²½ì´ë¯¸ì§€,ìºë¦­í„°ì´ë¯¸ì§€,ìƒíƒœì°½
                const history_text = document.querySelector(".history-container");
                console.log('ì„œë²„ë¡œë¶€í„° ë°›ì€ ë°ì´í„°:', data);
                rawText = data.buffer;
                const lines = rawText.split("\n");
                console.log(lines);
                var character ="";
                var place = "";
                var lastMessage = "";
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if(line.includes("Human:")) {
                        const idx = line.indexOf(":");
                        if (idx !== -1) {
                            history_text.innerHTML += `<span style="color: red;">${line.substring(idx + 1)}</span><br>`;
                        }
                    }else if(line.includes("AI:")) {
                        // SKIP
                        lastMessage="";
                        const matches = line.match(/\[(.+?)\]\s\[(.+?)\]/);
                       
                        if (matches) {
                            character = matches[1];
                            place = matches[2];
                            const nametag = document.querySelector(".name");
                            nametag.innerHTML = character;
                        }
                    }else{
                        const formattedText = formatText(line).replace(/\n/g, '<br>');
                        history_text.innerHTML += formattedText;
                        lastMessage+= formattedText+"<br>";
                    }
                };
                const imgpath = getPlaceImg(place);
                if (imgpath != "") {
                    document.body.style.backgroundImage = `url(${imgpath})`;
                }
                const imgpathchar = getCharacterImg(character);
                if (imgpathchar != "") {
                    const containerbg = document.querySelector(".character-image");
                    containerbg.style.background = `url(${imgpathchar}) no-repeat center/cover fixed`;
                }
                
                const dialogue_text = document.querySelector(".dialogue");
                dialogue_text.innerHTML = "";
                let index = 0;
                function typeWriter() {
                    if (index < lastMessage.length) {
                        dialogue_text.innerHTML = lastMessage.substring(0, index + 1);
                        index++;
                        setTimeout(typeWriter, 5); // Adjust delay as needed
                    }
                }
                typeWriter();
            })
        } else {
            navigator.sendBeacon('/start');    
        }
        
        
        window.addEventListener('beforeunload', function () {
            navigator.sendBeacon('/end');  // ì„œë²„ì— ì„¸ì…˜ ì¢…ë£Œ ìš”ì²­
        });
        const historyContainer = document.querySelector(".history-container");
        const blur_background = document.querySelector(".blurry-background");
        const closeButton = document.querySelector(".HistoryCloseButton");

        function closeHistory() {
            console.log('close');
            historyContainer.style.opacity = '0';
            blur_background.style.opacity = '0';
            closeButton.style.opacity = '0';
            setTimeout(function() {
                blur_background.style.display = 'none';
                historyContainer.style.display = 'none';
                closeButton.style.display = 'none';
            }, 200);
        };

        function printHistory() {
            historyContainer.style.opacity = '0';
            blur_background.style.opacity = '0';
            closeButton.style.opacity = '0';
            blur_background.style.display = 'flex';
            historyContainer.style.display = 'flex';
            closeButton.style.display = 'flex';
            setTimeout(function() {
                historyContainer.style.opacity = '1';
                blur_background.style.opacity = '1';
                closeButton.style.opacity = '1';
                
            }, 200);

            
        }
        /**
         * í…ìŠ¤íŠ¸ë¥¼ ë°›ì•„ ë”°ì˜´í‘œë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ, 
         * ê·¸ë ‡ì§€ ì•Šì€ ë¶€ë¶„ì€ grayìƒ‰ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ë‹¤ì‹œ ë°˜í™˜
         * @param {string} text - ë³€í™˜í•  í…ìŠ¤íŠ¸
         * @returns {string} - ë³€í™˜ëœ í…ìŠ¤íŠ¸
         */
        function formatText(text) {
            // ì •ê·œí‘œí˜„ì‹ì„ ì‚¬ìš©í•˜ì—¬ ë”°ì˜´í‘œë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ë¶€ë¶„ê³¼ ê·¸ë ‡ì§€ ì•Šì€ ë¶€ë¶„ì„ ë¶„ë¦¬
            // textë¥¼ ë”°ì˜´í‘œë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ë¶€ë¶„ê³¼ ê·¸ë ‡ì§€ ì•Šì€ ë¶€ë¶„ìœ¼ë¡œ ë‚˜ëˆ”
            // ì˜ˆ) "ì´ ë¶€ë¶„ì€ ë”°ì˜´í‘œë¡œ ë‘˜ëŸ¬ì‹¸ì—¬ ìˆìŠµë‹ˆë‹¤." ì¼ë°˜ í…ìŠ¤íŠ¸
            //     => ["", "ì´ ë¶€ë¶„ì€ ë”°ì˜´í‘œë¡œ ë‘˜ëŸ¬ì‹¸ì—¬ ìˆìŠµë‹ˆë‹¤.", ""]
            const parts = text.split(/(â€œ.*?â€|".*?")/).filter(Boolean);
            // ê° ë¶€ë¶„ì„ ì²˜ë¦¬
            const formattedParts = parts.map(part => {
                console.log(part);
                if (part.includes('"') || part.includes('â€œ') || part.includes('â€')) {
                    // ë”°ì˜´í‘œë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
                    return part;
                } else {
                    // ì¼ë°˜ í…ìŠ¤íŠ¸ëŠ” grayìƒ‰ìœ¼ë¡œ ë³€ê²½
                    return `<span style="color: gray;">${part}</span>`;
                }
            });
            
            // ì²˜ë¦¬ëœ ë¶€ë¶„ë“¤ì„ ë‹¤ì‹œ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ê²°í•©
            return formattedParts.join('');
        }
        document.getElementById("input_prompt").addEventListener("keydown", function (event) {
        // Enter í‚¤ í™•ì¸ (í‚¤ ì½”ë“œ: 13)
        if (event.key === "Enter") {
            onClickSend(); // í•¨ìˆ˜ ì‹¤í–‰
        }
        });
      
        function onClickSend(){
            const textToSend = document.getElementById("input_prompt");
            const history_text = document.querySelector(".history-container");
            history_text.innerHTML += `<span style="color: red;">${textToSend.value}</span><br><br>`;
            var prompt_input_text = textToSend.value;
            textToSend.value = " ";
            loadingGif.style.display = 'block'; // ë¡œë”© GIF í‘œì‹œ
            if (!window.matchMedia("(pointer: fine)").matches) {
                textToSend.blur(); // ì…ë ¥ì°½ì—ì„œ í¬ì»¤ìŠ¤ë¥¼ í•´ì œí•˜ì—¬ í‚¤ë³´ë“œ ë‹«ê¸°
            }
            fetch('/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ user_input: prompt_input_text })
            })
            .then(response => {
            if (!response.ok) {
                throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
            }
            return response.json();
            })
            .then(data => {
                textToSend.value="";
                console.log('ì„œë²„ë¡œë¶€í„° ë°›ì€ ë°ì´í„°:', data);
                // ì—¬ê¸°ì„œ ë°›ì€ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
                loadingGif.style.display = 'none';
                
                const dialogue_text = document.querySelector(".dialogue");
                
                rawText = data.data.text
                const lines = rawText.split("\n");
                const firstLine = lines[0];
                const matches = firstLine.match(/\[(.+?)\]\s\[(.+?)\]/);
                var character ="";
                var place = "";
                if (matches) {
                    character = matches[1];
                    place = matches[2];
                    const nametag = document.querySelector(".name");
                    nametag.innerHTML = character;
                }
                console.log("character:", character, "place:", place);
                
                var rawText = lines.slice(1).join("\n");
               
                console.log('rawText',rawText);
                const formattedText = formatText(rawText).replace(/\n/g, '<br>');
                
                let index = 0;
                dialogue_text.innerHTML = "";

                function typeWriter() {
                    if (index < formattedText.length) {
                        dialogue_text.innerHTML = formattedText.substring(0, index + 1);
                        index++;
                        setTimeout(typeWriter, 5); // Adjust delay as needed
                    }
                }
                typeWriter();
                
                history_text.innerHTML += formattedText;
                // status
                const stat_text = document.querySelector(".status-text")
                let result = "";
                Object.entries(data.char_state).forEach(entry => {
                    console.log(entry);
                    const symbol = entry[1].first_appearance ? `[${entry[0]}]` : "";
                    result+=symbol;
                    //result.push(`${entry[0]}: ${symbol}`);
                });
                stat_text.innerHTML = "ğŸ’–HP: 100/100 ğŸ’MP: 50/50 <br>ë°œê²¬í•œ ì¸ë¬¼ :"+result
                //textToSend.focus();
                //
                const imgpath = getPlaceImg(place);
                if (imgpath != "") {
                    document.body.style.backgroundImage = `url(${imgpath})`;
                }
                const imgpathchar = getCharacterImg(character);
                if (imgpathchar != "") {
                    const containerbg = document.querySelector(".character-image");
                    containerbg.style.background = `url(${imgpathchar}) no-repeat center/cover fixed`;
                }
            })
            .catch(error => {
            console.error('fetch ì‘ì—… ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            });


        }
        function getPlaceImg(place) {
            switch (place) {
                case "ìˆ²ì† ì˜¤ë‘ë§‰":
                    return "static/bg/forest_cabin.png";
                case "ì ì‚¬ì ì„±":
                    return "static/bg/ruins_of_red_lion.png";
                case "ë¼ê±°ìŠ¤ ìš©ë³‘ë‹¨":
                    return "static/bg/lagerus_mercenary_camp.png";
                case "ì„¸ê°œì˜ íƒ‘":
                    return "static/bg/three_towers.png";
                case "ì„¸ ê°œì˜ íƒ‘":
                    return "static/bg/three_towers.png";
                case "ë¯¸ì¼ˆë¼ ì„±ìˆ˜":
                    return "static/bg/michela_tree.png";
                case "ë…¹íŠ¸ëŸ´ ì„±":
                    return "static/bg/noctrul_castle.png";
                case "ë…¹íŠ¸ëŸ´ ì„± ì§€í•˜ ì„¸ê³„":
                    return "static/bg/noctrul_underworld.png";
                default:
                    return "";
            }
        }
        function getCharacterImg(character) {
            var characterList =["í•œë‹ˆë°œ","ë¼ê±°ìŠ¤","ë¼ë‹ˆ","ë¸”ë™ë“œë˜ê³¤","ë…¹íŠ¸ëŸ´ í™©ì œ","ì—ìŠ¤ë©”ë„ë‹¤","ë§ë ˆë‹ˆì•„","ë¼ë‹¨","ë„¤í¬ë¡œë©˜ì„œ"];
            var reg = new RegExp(characterList.join("|"), "i");
            var match = character.match(reg);
            console.log(match);
            console.log(match[0]);
            switch (match[0]) {
                case "í•œë‹ˆë°œ":
                    return "static/character/hannibal.png";
                case "ë¼ê±°ìŠ¤":
                    return "static/character/ragus.png";
                case "ë¼ë‹ˆ":
                    return "static/character/rani.png";
                case "ë‹¬ì˜ì™•ë…€ ë¼ë‹ˆ":
                    return "static/character/rani.png";
                case "ë¸”ë™ë“œë˜ê³¤":
                    return "static/character/blackdragon.png";
                case "ë…¹íŠ¸ëŸ´ í™©ì œ":
                    return "static/character/emperer.png";
                case "ì—ìŠ¤ë©”ë„ë‹¤":
                    return "static/character/esmeralda.png";
                case "ë§ë ˆë‹ˆì•„":
                    return "static/character/malenia.png";
                case "ë¶€íŒ¨ì˜ ì—¬ì‹  ë§ë ˆë‹ˆì•„":
                    return "static/character/malenia.png";
                case "ë¼ë‹¨":
                    return "static/character/radan.png";
                case "ì¥êµ° ë¼ë‹¨":
                    return "static/character/radan.png";
                case "ë„¤í¬ë¡œë©˜ì„œ":
                    return "static/character/necromencer.png";
                default:
                    return "";
            }
        }
    </script>
</body>
</html>
